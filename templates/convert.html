{% extends "base.html" %}

{% block title %}Convert - Olex2RTZ{% endblock %}

{% block content %}
    <h1>Routes and Waypoints</h1>
    <form method="post" action="/convert">
        <label for="route">Choose a route to convert:</label>
        <select name="route" id="route">
            {% for route in routes %}
                <option value="{{ route.route_name }}">{{ route.route_name }}</option>
            {% endfor %}
        </select>
        <label for="toggle_rename" style="display: block; margin-top: 10px;">
            <span>Rename the route</span>
            <label class="switch">
                <input type="checkbox" id="toggle_rename">
                <span class="slider"></span>
            </label>
        </label>
        <div id="rename_field" style="display: none; margin-top: 10px;">
            <input type="text" name="new_name" id="new_name" placeholder="Enter new route name">
        </div>
        <button type="submit">Convert</button>
    </form>

    <div id="map" style="height: 500px; margin-top: 20px; margin-bottom: 20px;"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var routes = {{ routes_js | safe }};
        var map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://carto.com/attributions">CartoDB</a>',
            maxZoom: 19
        }).addTo(map);

        var currentRoute = null;
        var currentMarkers = [];

        const circleIcon = L.divIcon({
            className: 'leaflet-marker-icon',
            iconSize: [12, 12],
            iconAnchor: [6, 6],
            popupAnchor: [0, -10],
            style: {
                'background-color': '#004080',
                'border-radius': '50%',
                'width': '12px',
                'height': '12px',
                'border': 'none',
                'box-shadow': '0 0 10px rgba(0, 0, 0, 0.3)',
            }
        });

        function updateMap(routeName) {
            if (currentRoute) {
                map.removeLayer(currentRoute);
            }
            currentMarkers.forEach(function(marker) {
                map.removeLayer(marker);
            });
            currentMarkers = [];
            var waypoints = routes[routeName];
            if (!waypoints) {
                console.error("Unknown route: " + routeName);
                return;
            }

            var latlngs = waypoints.map(function(wp) {
                return [wp.lat, wp.lon];
            });

            latlngs.forEach(function(coords, index) {
                var waypointName = waypoints[index].name || "WP" + (index + 1);
                var marker = L.marker(coords, {icon: circleIcon}).addTo(map)
                    .bindPopup(waypointName)
                    .on('mouseover', function(e) {
                        this.openPopup();
                    })
                    .on('mouseout', function(e) {
                        this.closePopup();
                    });
                currentMarkers.push(marker);
            });

            currentRoute = L.polyline(latlngs, {color: '#004080'}).addTo(map);
            map.fitBounds(currentRoute.getBounds());
        }

        document.getElementById('route').addEventListener('change', function() {
            updateMap(this.value);
        });

        document.getElementById('toggle_rename').addEventListener('change', function() {
            var renameField = document.getElementById('rename_field');
            renameField.style.display = this.checked ? 'block' : 'none';
        });

        window.onload = function() {
            var initialRoute = document.getElementById('route').value;
            updateMap(initialRoute);
        };
    </script>
{% endblock %}